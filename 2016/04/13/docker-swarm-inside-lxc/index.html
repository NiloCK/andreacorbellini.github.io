<!doctype html>
<html lang="en">
  <head>
      <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,maximum-scale=1,initial-scale=1,user-scalable=0">
    <link href="http://andrea.corbellini.name/feed.atom" type="application/atom+xml" rel="alternate" title="Andrea Corbellini Atom Feed">
    <link href="http://andrea.corbellini.name/feed.rss" type="application/rss+xml" rel="alternate" title="Andrea Corbellini RSS Feed">
      <link rel="stylesheet" href="http://andrea.corbellini.name/theme/css/style.min.css?cc6373d9">

      <meta name="tags" content="docker">
      <meta name="tags" content="swarm">
      <meta name="tags" content="lxc">
      <meta name="tags" content="containers">
      <meta name="tags" content="distributed-computing">
    <link rel="canonical" href="http://andrea.corbellini.name/2016/04/13/docker-swarm-inside-lxc/">
    <title>Running Docker Swarm inside LXC - Andrea Corbellini</title>
  </head>
  <body>
    <header class="main-header">  <nav class="navbar navbar-inverse">
    <div class="container">
      <button class="visible-xs-block" type="button" data-toggle="collapse" data-target=".navbar-collapse"><span class="fa fa-bars"></span></button>
      <div class="navbar-header">
        <a class="navbar-brand" href="http://andrea.corbellini.name/">Andrea Corbellini</a>
      </div>
      <div class="collapse navbar-collapse">
        <ul class="nav navbar-nav navbar-right">
          <li><a href="http://andrea.corbellini.name/">Home</a></li>
            <li><a href="http://andrea.corbellini.name/about/">About</a></li>
        </ul>
      </div>
    </div>
  </nav>
</header>
      <div class="main-container container">
        <div class="row">
          <main id="content" class="left col-md-9">    <article>
      <header>
        <h1><a href="http://andrea.corbellini.name/2016/04/13/docker-swarm-inside-lxc/" rel="bookmark" title="Running Docker Swarm inside LXC">Running Docker Swarm inside LXC</a></h1>
<div class="details small">
  <span><span class="fa fa-calendar-o"></span><time datetime="2016-04-13T18:00:00+00:00">Wed 13 April 2016</time></span>
  <span><span class="fa fa-comments-o"></span><a href="http://andrea.corbellini.name/2016/04/13/docker-swarm-inside-lxc/#disqus_thread" title="Comments" data-disqus-identifier="docker-swarm-inside-lxc">Comments</a></span>
  <span>
    <span class="fa fa-tags"></span>
    <ul class="tags list-inline">
        <li><a href="http://andrea.corbellini.name/tag/docker/" rel="tag" class="" title="docker">docker</a></li>
        <li><a href="http://andrea.corbellini.name/tag/swarm/" rel="tag" class="" title="swarm">swarm</a></li>
        <li><a href="http://andrea.corbellini.name/tag/lxc/" rel="tag" class="" title="lxc">lxc</a></li>
        <li><a href="http://andrea.corbellini.name/tag/containers/" rel="tag" class="" title="containers">containers</a></li>
        <li><a href="http://andrea.corbellini.name/tag/distributed-computing/" rel="tag" class="" title="distributed-computing">distributed-computing</a></li>
    </ul>
  </span>
</div>      </header>
      <div class="body"><p>I've been using <a href="https://docs.docker.com/swarm/">Docker Swarm</a> inside <a href="https://linuxcontainers.org/lxc/introduction/">LXC</a> containers for a while now, and I thought that I could share my experience with you. Due to their nature, LXC containers are pretty lightweight and require very few resources if compared to virtual machines. This makes LXC ideal for development and simulation purposes. Running Docker Swarm inside LXC requires a few steps that I'm going to show you in this tutorial.</p>
<p>Before we begin, a quick premise: LXC, Docker and Swarm can be configured in many different ways. Here I'm showing just my preferred setup: LXC with AppArmor disabled, Docker with the OverlayFS storage driver, Swarm with etcd discovery. There exist many other kind of configurations that can work under LXC &mdash; leave a comment if you want to know more.</p>
<p><strong>Overview:</strong></p>
<ol>
<li><a href="#step-1">Create the Swarm Manager container</a></li>
<li><a href="#step-2">Modify configuration for the Swarm Manager container</a></li>
<li><a href="#step-3">Load the OverlayFS module</a></li>
<li><a href="#step-4">Start the container and install Docker</a></li>
<li><a href="#step-5">Check if Docker is working</a></li>
<li><a href="#step-6">Set up the Swarm Manager</a></li>
<li><a href="#step-7">Create the Swarm Agents</a></li>
<li><a href="#step-8">Play with the Swarm</a></li>
</ol>
<p><strong>Terminology:</strong></p>
<ul>
<li>the <em>host</em> is the system that will create and start the LXC containers (e.g. your laptop);</li>
<li>the <em>manager</em> is the LXC container that will run the Swarm manager (it'll run the <code>swarm manage</code> command);</li>
<li>an <em>agent</em> is one of the many LXC containers that will run a Swarm agent node (it'll run the <code>swarm join</code> command);</li>
</ul>
<p>To avoid ambiguity, all commands will be prefixed with a prompt such as <code>root@host:~#</code>, <code>root@swarm-manager:~#</code> and <code>root@swarm-agent-1:~#</code>.</p>
<p><strong>Prerequisites:</strong></p>
<p>This tutorial assumes that you have at least a vague idea of what Docker and Docker Swarm are. You should also be familiar with the shell.</p>
<p>This tutorial has been succesfully tested on Ubuntu 15.10 (that ships with Docker 1.6) and Ubuntu 16.04 LTS (Docker 1.10), but it may work on other distributions and Docker versions as well.</p>
<h2 id="step-1">Step 1: Create the Swarm Manager container</h2>
<p>Create a new LXC container with:</p>
<div class="highlight"><pre><span></span><span class="gp">root@host:~#</span> lxc-create -t download -n swarm-manager
</pre></div>


<p>When prompted, choose your favorite distribution and architecture. I chose <code>ubuntu</code> / <code>xenial</code> / <code>amd64</code>.</p>
<p><code>lxc-create</code> needs to run as root, <a href="https://www.stgraber.org/2014/01/17/lxc-1-0-unprivileged-containers/">unprivileged containers</a> won't work. We could actually make Docker start inside an unprivileged container, the problem is that we wouldn't be allowed to create block and character devices, and many Docker containers need this ability.</p>
<h2 id="step-2">Step 2: Modify the configuration for the Swarm Manager container</h2>
<p>Before starting the LXC container, open the file <code>/var/lib/lxc/swarm-manager/config</code> on the host and add the following configuration to the bottom of the file:</p>
<div class="highlight"><pre><span></span><span class="c1"># Distribution configuration</span>
<span class="c1"># ...</span>

<span class="c1"># Container specific configuration</span>
<span class="c1"># ...</span>

<span class="c1"># Network configuration</span>
<span class="c1"># ...</span>

<span class="c1"># Allow running Docker inside LXC</span>
lxc.aa_profile <span class="o">=</span> unconfined
lxc.cap.drop <span class="o">=</span>
</pre></div>


<p>The first rule (<code>lxc.aa_profile = unconfined</code>) disables AppArmor confinement. The second one (<code>lxc.cap.drop =</code>) gives all capabilities to the processes in LXC container.</p>
<p>These two rules may seem harmful from a security standpoint, and in fact they are. However we must remember that we will be running Docker inside the LXC container. Docker already ships with its own AppArmor profile and the two rules above are needed exactly for the purposes of letting Docker talk to AppArmor.</p>
<p>So, while Docker itself won't be confined, <strong>Docker containers will be confined</strong>, and this is an encouraging fact.</p>
<h2 id="step-3">Step 3: Load the OverlayFS module</h2>
<p>OverlayFS is shipped with Ubuntu, but not enabled by default. To enable it:</p>
<div class="highlight"><pre><span></span><span class="gp">root@host:~#</span> modprobe overlay
</pre></div>


<p>It is important to do this step before installing Docker. Docker supports various storage drivers and when Docker is installed for the first time it tries to detect the most appropriate one for the system. If Docker detects that OverlayFS is not loaded, it'll fall back to the device mapper. There's nothing wrong with the device mapper, we can make it work, however, as I said at the beginning, in this tutorial I'm focusing only on OverlayFS.</p>
<p>If you want to load OverlayFS at boot, instead of doing it manually after every reboot, add it to <code>/etc/modules-load.d/modules.conf</code>:</p>
<div class="highlight"><pre><span></span><span class="gp">root@host:~#</span> <span class="nb">echo</span> overlay &gt;&gt; /etc/modules-load.d/modules.conf
</pre></div>


<h2 id="step-4">Step 4: Start the container and install Docker</h2>
<p>It's time to see if we did everything right!</p>
<div class="highlight"><pre><span></span><span class="gp">root@host:~#</span> lxc-start -n swarm-manager
<span class="gp">root@host:~#</span> lxc-attach -n swarm-manager
<span class="gp">root@swarm-manager:~#</span> apt update
<span class="gp">root@swarm-manager:~#</span> apt install docker.io
</pre></div>


<p>Installation should complete without any problem. If you get an error like this:</p>
<div class="highlight"><pre><span></span>Job for docker.service failed because the control process exited with error code. See &quot;systemctl status docker.service&quot; and &quot;journalctl -xe&quot; for details.
invoke-rc.d: initscript docker, action &quot;start&quot; failed.
dpkg: error processing package docker.io (--configure):
 subprocess installed post-installation script returned error exit status 1
</pre></div>


<p>It means that Docker failed to start. Try checking <code>systemctl status docker</code> as suggested, or run <code>docker daemon</code> manually. You might get an error like this:</p>
<div class="highlight"><pre><span></span><span class="gp">root@swarm-manager:~#</span> docker daemon
<span class="go">WARN[0000] devmapper: Udev sync is not supported. This will lead to unexpected behavior, data loss and errors. For more information, see https://docs.docker.com/reference/commandline/daemon/#daemon-storage-driver-option</span>
<span class="go">ERRO[0000] There are no more loopback devices available.</span>
<span class="go">ERRO[0000] [graphdriver] prior storage driver &quot;devicemapper&quot; failed: loopback attach failed</span>
<span class="go">FATA[0000] Error starting daemon: error initializing graphdriver: loopback attach failed</span>
</pre></div>


<p>In this case, Docker is using the devicemapper storage driver and is complaining about the lack of loopback devices. If that's the case, check whether OverlayFS is loaded and reinstall Docker.</p>
<p>Or you might get an error like this:</p>
<div class="highlight"><pre><span></span><span class="gp">root@swarm-manager:~#</span> docker daemon
<span class="go">XXX</span>
</pre></div>


<p>It this other case, Docker is complaining about the fact that it can't talk to AppArmor. Check the configuration for the LXC container.</p>
<h2 id="step-5">Step 5: Check if Docker is working</h2>
<p>Once you are all set, you should be able to use Docker: try running <code>docker info</code>, <code>docker ps</code> or launch a container:</p>
<div class="highlight"><pre><span></span><span class="gp">root@swarm-manager:~#</span> docker run --rm docker/whalesay cowsay burp!
<span class="go">Unable to find image &#39;docker/whalesay:latest&#39; locally</span>
<span class="go">latest: Pulling from docker/whalesay</span>
<span class="go">...</span>
<span class="go">Status: Downloaded newer image for docker/whalesay:latest</span>
<span class="go"> _______</span>
<span class="go">&lt; burp! &gt;</span>
<span class="go"> -------</span>
<span class="go">    \</span>
<span class="go">     \</span>
<span class="go">      \</span>
<span class="gp">                    #</span><span class="c1">#        .</span>
<span class="gp">              #</span><span class="c1"># ## ##       ==</span>
<span class="gp">           #</span><span class="c1"># ## ## ##      ===</span>
<span class="go">       /&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;___/ ===</span>
<span class="go">  ~~~ {~~ ~~~~ ~~~ ~~~~ ~~ ~ /  ===- ~~~</span>
<span class="go">       \______ o          __/</span>
<span class="go">        \    \        __/</span>
<span class="go">          \____\______/</span>
</pre></div>


<p>It appears to be working. By the way, we can check whether Docker is correctly confining containers. Try running a Docker container and check on the host the output of <code>aa-status</code>: you should see a process running with the <code>docker-default</code> profile. For example:</p>
<div class="highlight"><pre><span></span><span class="gp">root@swarm-manager:~#</span> docker run --rm ubuntu bash -c <span class="s1">&#39;while true; do sleep 1; echo -n zZ; done&#39;</span>
<span class="go">zZzZzZzZzZzZzZzZ...</span>

<span class="gp">#</span> On another shell
<span class="gp">root@host:~#</span> aa-status
<span class="go">apparmor module is loaded.</span>
<span class="go">5 profiles are loaded.</span>
<span class="go">5 profiles are in enforce mode.</span>
<span class="go">   /sbin/dhclient</span>
<span class="go">   /usr/lib/NetworkManager/nm-dhcp-client.action</span>
<span class="go">   /usr/lib/NetworkManager/nm-dhcp-helper</span>
<span class="go">   /usr/lib/connman/scripts/dhclient-script</span>
<span class="go">   docker-default</span>
<span class="go">0 profiles are in complain mode.</span>
<span class="go">4 processes have profiles defined.</span>
<span class="go">4 processes are in enforce mode.</span>
<span class="go">   /sbin/dhclient (797)</span>
<span class="go">   /sbin/dhclient (2832)</span>
<span class="go">   docker-default (6956)</span>
<span class="go">   docker-default (6973)</span>
<span class="go">0 processes are in complain mode.</span>
<span class="go">0 processes are unconfined but have a profile defined.</span>

<span class="gp">root@host:~#</span> ps -ef <span class="p">|</span> grep 6956
<span class="go">root      6956  4982  0 17:17 ?        00:00:00 bash -c while true; do sleep 1; echo -n zZ; done</span>
<span class="go">root      6973  6956  0 17:17 ?        00:00:00 sleep 1</span>
<span class="go">root      6982  6808  0 17:17 pts/3    00:00:00 grep --color=auto 6956</span>
</pre></div>


<p>Yay! Everything is running as expected: we launched a process inside a Docker container, and that process is running with the <code>docker-default</code> AppArmor profile. Once again: even if LXC is running unconfined, our Docker containers are not.</p>
<h2 id="step-6">Step 6: Set up the Swarm Manager</h2>
<p>That was the hardest part. Now we can proceed setting up Swarm as we would usually do.</p>
<p>As I said at the beginning, Swarm can be configured in many ways. In this tutorial I'll show how to set it up with etcd discovery. First of all, we need the IP address of the LXC container:</p>
<div class="highlight"><pre><span></span><span class="gp">root@swarm-manager:~#</span> ifconfig eth0
<span class="go">eth0      Link encap:Ethernet  HWaddr 00:16:3e:8e:cb:43</span>
<span class="go">          inet addr:10.0.3.154  Bcast:10.0.3.255  Mask:255.255.255.0</span>
<span class="go">          inet6 addr: fe80::216:3eff:fe8e:cb43/64 Scope:Link</span>
<span class="go">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span>
<span class="go">          RX packets:23177 errors:0 dropped:0 overruns:0 frame:0</span>
<span class="go">          TX packets:20859 errors:0 dropped:0 overruns:0 carrier:0</span>
<span class="go">          collisions:0 txqueuelen:1000</span>
<span class="go">          RX bytes:147652946 (147.6 MB)  TX bytes:1455613 (1.4 MB)</span>
</pre></div>


<p><code>10.0.3.154</code> is my IP address. Let's start etcd:</p>
<div class="highlight"><pre><span></span><span class="gp">root@swarm-manager:~#</span> <span class="nv">SWARM_MANAGER_IP</span><span class="o">=</span>10.0.3.154

<span class="gp">root@swarm-manager:~#</span> docker run -d --restart<span class="o">=</span>always --name<span class="o">=</span>etcd -p 4001:4001 -p 2380:2380 -p 2379:2379 <span class="se">\</span>
<span class="go">                            quay.io/coreos/etcd -name etcd0 \</span>
<span class="go">                            -advertise-client-urls http://$SWARM_MANAGER_IP:2379,http://$SWARM_MANAGER_IP:4001 \</span>
<span class="go">                            -listen-client-urls http://0.0.0.0:2379,http://0.0.0.0:4001 \</span>
<span class="go">                            -initial-advertise-peer-urls http://$SWARM_MANAGER_IP:2380 \</span>
<span class="go">                            -listen-peer-urls http://0.0.0.0:2380 \</span>
<span class="go">                            -initial-cluster-token etcd-cluster-1 \</span>
<span class="go">                            -initial-cluster etcd0=http://$SWARM_MANAGER_IP:2380 \</span>
<span class="go">                            -initial-cluster-state new</span>
<span class="go">Unable to find image &#39;quay.io/coreos/etcd:latest&#39; locally</span>
<span class="go">latest: Pulling from coreos/etcd</span>
<span class="go">...</span>
<span class="go">Status: Downloaded newer image for quay.io/coreos/etcd:latest</span>
<span class="go">e742278a97d2ad3f88658aa871903d20b4094e551969a03aa8332d3876fe5d0d</span>

<span class="gp">root@swarm-manager:~#</span> docker ps
<span class="go">CONTAINER ID        IMAGE                 COMMAND                  CREATED             STATUS              PORTS                                                                NAMES</span>
<span class="go">e742278a97d2        quay.io/coreos/etcd   &quot;/etcd -name etcd0 -a&quot;   32 seconds ago      Up 31 seconds       0.0.0.0:2379-2380-&gt;2379-2380/tcp, 0.0.0.0:4001-&gt;4001/tcp, 7001/tcp   etcd</span>
</pre></div>


<p>Replace <code>10.0.3.154</code> with the IP address of your LXC container.</p>
<p>Note that I've started etcd with <code>--restart=always</code>, so that every time etcd is automatically started when the LXC container starts. With this option, etcd will restart even if you explicitly stop it. Drop <code>--restart=always</code> if that's not what you want.</p>
<p>Now we can start the Swarm manager:</p>
<div class="highlight"><pre><span></span><span class="gp">root@swarm-manager:~#</span> docker run -d --restart<span class="o">=</span>always --name<span class="o">=</span>swarm -p 3375:3375 <span class="se">\</span>
<span class="go">                            swarm manage -H 0.0.0.0:3375 etcd://$SWARM_MANAGER_IP:2379</span>
<span class="go">Unable to find image &#39;swarm:latest&#39; locally</span>
<span class="go">latest: Pulling from library/swarm</span>
<span class="go">...</span>
<span class="go">Status: Downloaded newer image for swarm:latest</span>
<span class="go">8080c93c544ff92cc2cf682ff0bbc82e0d2dfb01e1f98f202c3a0801d3427330</span>

<span class="gp">root@swarm-manager:~#</span> docker ps
<span class="go">CONTAINER ID        IMAGE                 COMMAND                  CREATED             STATUS              PORTS                                                                NAMES</span>
<span class="go">46b556e73e87        swarm                 &quot;/swarm manage -H 0.0&quot;   3 seconds ago       Up 2 seconds        2375/tcp, 0.0.0.0:3375-&gt;3375/tcp                                     swarm</span>
<span class="go">e742278a97d2        quay.io/coreos/etcd   &quot;/etcd -name etcd0 -a&quot;   7 minutes ago       Up 7 minutes        0.0.0.0:2379-2380-&gt;2379-2380/tcp, 0.0.0.0:4001-&gt;4001/tcp, 7001/tcp   etcd</span>
</pre></div>


<p>Our Swarm manager is up and running. We can connect to it and issue a few commands:</p>
<div class="highlight"><pre><span></span><span class="gp">root@swarm-manager:~#</span> docker -H localhost:3375 info
<span class="go">Containers: 0</span>
<span class="go"> Running: 0</span>
<span class="go"> Paused: 0</span>
<span class="go"> Stopped: 0</span>
<span class="go">Images: 0</span>
<span class="go">Server Version: swarm/1.1.3</span>
<span class="go">Role: primary</span>
<span class="go">Strategy: spread</span>
<span class="go">Filters: health, port, dependency, affinity, constraint</span>
<span class="go">Nodes: 0</span>
<span class="go">Plugins:</span>
<span class="go"> Volume:</span>
<span class="go"> Network:</span>
<span class="go">Kernel Version: 4.4.0-15-generic</span>
<span class="go">Operating System: linux</span>
<span class="go">Architecture: amd64</span>
<span class="go">CPUs: 0</span>
<span class="go">Total Memory: 0 B</span>
<span class="go">Name: d39c33295ef3</span>
</pre></div>


<p>As you can see there are no nodes connected, as we would expect. Everything looks good.</p>
<h2 id="step-7">Step 7: Create the Swarm Agents</h2>
<p>Our Swarm manager can't do anything interesting without agent nodes. Creating new LXC containers for the agents is not much different from what we already did with the manager. To set up new agents in an automatic fashion I've created a script, so that you don't need to repeat the steps manually:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>

<span class="nb">set</span> -eu

<span class="nv">SWARM_MANAGER_IP</span><span class="o">=</span>10.0.3.154
<span class="nv">DOWNLOAD_DIST</span><span class="o">=</span>ubuntu
<span class="nv">DOWNLOAD_RELEASE</span><span class="o">=</span>xenial
<span class="nv">DOWNLOAD_ARCH</span><span class="o">=</span>amd64

<span class="k">for</span> LXC_NAME in <span class="s2">&quot;</span><span class="nv">$@</span><span class="s2">&quot;</span>
<span class="k">do</span>
    <span class="nv">LXC_PATH</span><span class="o">=</span><span class="s2">&quot;/var/lib/lxc/</span><span class="nv">$LXC_NAME</span><span class="s2">&quot;</span>
    <span class="nv">LXC_ROOTFS</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$LXC_PATH</span><span class="s2">/rootfs&quot;</span>

    <span class="c1"># Create the container.</span>
    lxc-create -t download -n <span class="s2">&quot;</span><span class="nv">$LXC_NAME</span><span class="s2">&quot;</span> -- <span class="se">\</span>
        -d <span class="s2">&quot;</span><span class="nv">$DOWNLOAD_DIST</span><span class="s2">&quot;</span> -r <span class="s2">&quot;</span><span class="nv">$DOWNLOAD_RELEASE</span><span class="s2">&quot;</span> -a <span class="s2">&quot;</span><span class="nv">$DOWNLOAD_ARCH</span><span class="s2">&quot;</span>

    cat <span class="s">&lt;&lt;EOF &gt;&gt; &quot;$LXC_PATH/config&quot;</span>
<span class="s"># Allow running Docker inside LXC</span>
<span class="s">lxc.aa_profile = unconfined</span>
<span class="s">lxc.cap.drop =</span>
<span class="s">EOF</span>

    <span class="c1"># Start the container and wait for networking to start.</span>
    lxc-start -n <span class="s2">&quot;</span><span class="nv">$LXC_NAME</span><span class="s2">&quot;</span>
    sleep 10s

    <span class="c1"># Install Docker.</span>
    lxc-attach -n <span class="s2">&quot;</span><span class="nv">$LXC_NAME</span><span class="s2">&quot;</span> -- apt-get update
    lxc-attach -n <span class="s2">&quot;</span><span class="nv">$LXC_NAME</span><span class="s2">&quot;</span> -- apt-get install -y docker.io

    <span class="c1"># Tell Docker to listen on all interfaces.</span>
    sed -i -e <span class="s1">&#39;s/^#DOCKER_OPTS=.*$/DOCKER_OPTS=&quot;-H 0.0.0.0:2375&quot;/&#39;</span> <span class="s2">&quot;</span><span class="nv">$LXC_ROOTFS</span><span class="s2">/etc/default/docker&quot;</span>
    lxc-attach -n <span class="s2">&quot;</span><span class="nv">$LXC_NAME</span><span class="s2">&quot;</span> -- systemctl restart docker

    <span class="c1"># Join the Swarm.</span>
    <span class="nv">SWARM_AGENT_IP</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>lxc-attach -n <span class="s2">&quot;</span><span class="nv">$LXC_NAME</span><span class="s2">&quot;</span> -- ifconfig eth0 <span class="p">|</span> grep -Po <span class="s1">&#39;(?&lt;=inet addr:)\S+&#39;</span><span class="k">)</span><span class="s2">&quot;</span>
    lxc-attach -n <span class="s2">&quot;</span><span class="nv">$LXC_NAME</span><span class="s2">&quot;</span> -- docker run -d --restart<span class="o">=</span>always --name<span class="o">=</span>swarm <span class="se">\</span>
        swarm join --addr<span class="o">=</span><span class="s2">&quot;</span><span class="nv">$SWARM_AGENT_IP</span><span class="s2">:2375&quot;</span> <span class="s2">&quot;etcd://</span><span class="nv">$SWARM_MANAGER_IP</span><span class="s2">:2379&quot;</span>
<span class="k">done</span>
</pre></div>
</td></tr></table>

<p>Be sure to change the values for <code>SWARM_MANAGER_IP</code>, <code>DOWNLOAD_DIST</code>, <code>DOWNLOAD_RELEASE</code> and <code>DOWNLOAD_ARCH</code> to fit your needs.</p>
<p>Thanks to this script, creating 10 new agents is as simple as running one command:</p>
<div class="highlight"><pre><span></span><span class="gp">root@host:~#</span> ./swarm-agent-create swarm-agent-<span class="o">{</span>0..9<span class="o">}</span>
</pre></div>


<p>Here's an explaination of what the script does:</p>
<ul>
<li>
<p>It first sets up a new LXC container following steps 1-5 above, that is: create a new LXC container (with <code>lxc-create</code>), apply the LXC configuration (<code>lxc.aa_profile</code> and <code>lxc.cap.drop</code> rules), start the container and install Docker.</p>
<div class="highlight"><pre><span></span><span class="nv">LXC_PATH</span><span class="o">=</span><span class="s2">&quot;/var/lib/lxc/</span><span class="nv">$LXC_NAME</span><span class="s2">&quot;</span>
<span class="nv">LXC_ROOTFS</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$LXC_PATH</span><span class="s2">/rootfs&quot;</span>

<span class="c1"># Create the container.</span>
lxc-create -t download -n <span class="s2">&quot;</span><span class="nv">$LXC_NAME</span><span class="s2">&quot;</span> -- <span class="se">\</span>
    -d <span class="s2">&quot;</span><span class="nv">$DOWNLOAD_DIST</span><span class="s2">&quot;</span> -r <span class="s2">&quot;</span><span class="nv">$DOWNLOAD_RELEASE</span><span class="s2">&quot;</span> -a <span class="s2">&quot;</span><span class="nv">$DOWNLOAD_ARCH</span><span class="s2">&quot;</span>

cat <span class="s">&lt;&lt;EOF &gt;&gt; &quot;$LXC_PATH/config&quot;</span>
<span class="s"># Allow running Docker inside LXC</span>
<span class="s">lxc.aa_profile = unconfined</span>
<span class="s">lxc.cap.drop =</span>
<span class="s">EOF</span>

<span class="c1"># Start the container and wait for networking to start.</span>
lxc-start -n <span class="s2">&quot;</span><span class="nv">$LXC_NAME</span><span class="s2">&quot;</span>
sleep 10s

<span class="c1"># Install Docker.</span>
lxc-attach -n <span class="s2">&quot;</span><span class="nv">$LXC_NAME</span><span class="s2">&quot;</span> -- apt-get update
lxc-attach -n <span class="s2">&quot;</span><span class="nv">$LXC_NAME</span><span class="s2">&quot;</span> -- apt-get install -y docker.io
</pre></div>


</li>
<li>
<p>Our Swarm agents need to be reachable by the manager. For this reason we need to configure them so that they bind to a public interface. To do so, the script adds <code>DOCKER_OPTS="-H 0.0.0.0:2375"</code> and restarts Docker.</p>
<div class="highlight"><pre><span></span><span class="c1"># Tell Docker to listen on all interfaces.</span>
sed -i -e <span class="s1">&#39;s/^#DOCKER_OPTS=.*$/DOCKER_OPTS=&quot;-H 0.0.0.0:2375&quot;/&#39;</span> <span class="s2">&quot;</span><span class="nv">$LXC_ROOTFS</span><span class="s2">/etc/default/docker&quot;</span>
lxc-attach -n <span class="s2">&quot;</span><span class="nv">$LXC_NAME</span><span class="s2">&quot;</span> -- systemctl restart docker
</pre></div>


</li>
<li>
<p>Lastly, the script checks the IP address for the LXC container and it launches Swarm.</p>
<div class="highlight"><pre><span></span><span class="c1"># Join the Swarm.</span>
<span class="nv">SWARM_AGENT_IP</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>lxc-attach -n <span class="s2">&quot;</span><span class="nv">$LXC_NAME</span><span class="s2">&quot;</span> -- ifconfig eth0 <span class="p">|</span> grep -Po <span class="s1">&#39;(?&lt;=inet addr:)\S+&#39;</span><span class="k">)</span><span class="s2">&quot;</span>
lxc-attach -n <span class="s2">&quot;</span><span class="nv">$LXC_NAME</span><span class="s2">&quot;</span> -- docker run -d --restart<span class="o">=</span>always --name<span class="o">=</span>swarm <span class="se">\</span>
    swarm join --addr<span class="o">=</span><span class="s2">&quot;</span><span class="nv">$SWARM_AGENT_IP</span><span class="s2">:2375&quot;</span> <span class="s2">&quot;etcd://</span><span class="nv">$SWARM_MANAGER_IP</span><span class="s2">:2379&quot;</span>
</pre></div>


</li>
</ul>
<h2 id="step-8">Step 8: Play with the Swarm</h2>
<p>Now, if we check <code>docker info</code> on the Swarm manager, we should see 10 healthy nodes:</p>
<div class="highlight"><pre><span></span><span class="gp">root@swarm-manager:~#</span> docker -H localhost:3375 info
<span class="go">Containers: 10</span>
<span class="go"> Running: 10</span>
<span class="go"> Paused: 0</span>
<span class="go"> Stopped: 0</span>
<span class="go">Images: 10</span>
<span class="go">Server Version: swarm/1.1.3</span>
<span class="go">Role: primary</span>
<span class="go">Strategy: spread</span>
<span class="go">Filters: health, port, dependency, affinity, constraint</span>
<span class="go">Nodes: 10</span>
<span class="go"> swarm-agent-0: 10.0.3.73:2375</span>
<span class="go">  └ Status: Healthy</span>
<span class="go">  └ Containers: 1</span>
<span class="go">  └ Reserved CPUs: 0 / 4</span>
<span class="go">  └ Reserved Memory: 0 B / 4.052 GiB</span>
<span class="go">  └ Labels: executiondriver=native-0.2, kernelversion=4.4.0-15-generic, operatingsystem=Ubuntu 16.04, storagedriver=overlay</span>
<span class="go">  └ Error: (none)</span>
<span class="go">  └ UpdatedAt: 2016-04-13T15:32:35Z</span>
<span class="go"> swarm-agent-1: 10.0.3.97:2375</span>
<span class="go">  └ Status: Healthy</span>
<span class="go">  └ Containers: 1</span>
<span class="go">  └ Reserved CPUs: 0 / 4</span>
<span class="go">  └ Reserved Memory: 0 B / 4.052 GiB</span>
<span class="go">  └ Labels: executiondriver=native-0.2, kernelversion=4.4.0-15-generic, operatingsystem=Ubuntu 16.04, storagedriver=overlay</span>
<span class="go">  └ Error: (none)</span>
<span class="go">  └ UpdatedAt: 2016-04-13T15:31:49Z</span>
<span class="go"> swarm-agent-2: 10.0.3.58:2375</span>
<span class="go">  └ Status: Healthy</span>
<span class="go">  └ Containers: 1</span>
<span class="go">  └ Reserved CPUs: 0 / 4</span>
<span class="go">  └ Reserved Memory: 0 B / 4.052 GiB</span>
<span class="go">  └ Labels: executiondriver=native-0.2, kernelversion=4.4.0-15-generic, operatingsystem=Ubuntu 16.04, storagedriver=overlay</span>
<span class="go">  └ Error: (none)</span>
<span class="go">  └ UpdatedAt: 2016-04-13T15:31:54Z</span>
<span class="go"> swarm-agent-3: 10.0.3.195:2375</span>
<span class="go">  └ Status: Healthy</span>
<span class="go">  └ Containers: 1</span>
<span class="go">  └ Reserved CPUs: 0 / 4</span>
<span class="go">  └ Reserved Memory: 0 B / 4.052 GiB</span>
<span class="go">  └ Labels: executiondriver=native-0.2, kernelversion=4.4.0-15-generic, operatingsystem=Ubuntu 16.04, storagedriver=overlay</span>
<span class="go">  └ Error: (none)</span>
<span class="go">  └ UpdatedAt: 2016-04-13T15:32:03Z</span>
<span class="go"> swarm-agent-4: 10.0.3.235:2375</span>
<span class="go">  └ Status: Healthy</span>
<span class="go">  └ Containers: 1</span>
<span class="go">  └ Reserved CPUs: 0 / 4</span>
<span class="go">  └ Reserved Memory: 0 B / 4.052 GiB</span>
<span class="go">  └ Labels: executiondriver=native-0.2, kernelversion=4.4.0-15-generic, operatingsystem=Ubuntu 16.04, storagedriver=overlay</span>
<span class="go">  └ Error: (none)</span>
<span class="go">  └ UpdatedAt: 2016-04-13T15:32:22Z</span>
<span class="go"> swarm-agent-5: 10.0.3.174:2375</span>
<span class="go">  └ Status: Healthy</span>
<span class="go">  └ Containers: 1</span>
<span class="go">  └ Reserved CPUs: 0 / 4</span>
<span class="go">  └ Reserved Memory: 0 B / 4.052 GiB</span>
<span class="go">  └ Labels: executiondriver=native-0.2, kernelversion=4.4.0-15-generic, operatingsystem=Ubuntu 16.04, storagedriver=overlay</span>
<span class="go">  └ Error: (none)</span>
<span class="go">  └ UpdatedAt: 2016-04-13T15:32:16Z</span>
<span class="go"> swarm-agent-6: 10.0.3.222:2375</span>
<span class="go">  └ Status: Healthy</span>
<span class="go">  └ Containers: 1</span>
<span class="go">  └ Reserved CPUs: 0 / 4</span>
<span class="go">  └ Reserved Memory: 0 B / 4.052 GiB</span>
<span class="go">  └ Labels: executiondriver=native-0.2, kernelversion=4.4.0-15-generic, operatingsystem=Ubuntu 16.04, storagedriver=overlay</span>
<span class="go">  └ Error: (none)</span>
<span class="go">  └ UpdatedAt: 2016-04-13T15:32:21Z</span>
<span class="go"> swarm-agent-7: 10.0.3.140:2375</span>
<span class="go">  └ Status: Healthy</span>
<span class="go">  └ Containers: 1</span>
<span class="go">  └ Reserved CPUs: 0 / 4</span>
<span class="go">  └ Reserved Memory: 0 B / 4.052 GiB</span>
<span class="go">  └ Labels: executiondriver=native-0.2, kernelversion=4.4.0-15-generic, operatingsystem=Ubuntu 16.04, storagedriver=overlay</span>
<span class="go">  └ Error: (none)</span>
<span class="go">  └ UpdatedAt: 2016-04-13T15:31:43Z</span>
<span class="go"> swarm-agent-8: 10.0.3.95:2375</span>
<span class="go">  └ Status: Healthy</span>
<span class="go">  └ Containers: 1</span>
<span class="go">  └ Reserved CPUs: 0 / 4</span>
<span class="go">  └ Reserved Memory: 0 B / 4.052 GiB</span>
<span class="go">  └ Labels: executiondriver=native-0.2, kernelversion=4.4.0-15-generic, operatingsystem=Ubuntu 16.04, storagedriver=overlay</span>
<span class="go">  └ Error: (none)</span>
<span class="go">  └ UpdatedAt: 2016-04-13T15:32:17Z</span>
<span class="go"> swarm-agent-9: 10.0.3.125:2375</span>
<span class="go">  └ Status: Healthy</span>
<span class="go">  └ Containers: 1</span>
<span class="go">  └ Reserved CPUs: 0 / 4</span>
<span class="go">  └ Reserved Memory: 0 B / 4.052 GiB</span>
<span class="go">  └ Labels: executiondriver=native-0.2, kernelversion=4.4.0-15-generic, operatingsystem=Ubuntu 16.04, storagedriver=overlay</span>
<span class="go">  └ Error: (none)</span>
<span class="go">  └ UpdatedAt: 2016-04-13T15:32:30Z</span>
<span class="go">Plugins:</span>
<span class="go"> Volume:</span>
<span class="go"> Network:</span>
<span class="go">Kernel Version: 4.4.0-15-generic</span>
<span class="go">Operating System: linux</span>
<span class="go">Architecture: amd64</span>
<span class="go">CPUs: 40</span>
<span class="go">Total Memory: 40.52 GiB</span>
<span class="go">Name: d39c33295ef3</span>
</pre></div>


<p>Let's try running a command on the Swarm:</p>
<div class="highlight"><pre><span></span><span class="gp">root@swarm-manager:~#</span> docker -H localhost:3375 run -i --rm docker/whalesay cowsay <span class="s1">&#39;It works!&#39;</span>
<span class="go"> ___________</span>
<span class="go">&lt; It works! &gt;</span>
<span class="go"> -----------</span>
<span class="go">    \</span>
<span class="go">     \</span>
<span class="go">      \</span>
<span class="gp">                    #</span><span class="c1">#        .</span>
<span class="gp">              #</span><span class="c1"># ## ##       ==</span>
<span class="gp">           #</span><span class="c1"># ## ## ##      ===</span>
<span class="go">       /&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;___/ ===</span>
<span class="go">  ~~~ {~~ ~~~~ ~~~ ~~~~ ~~ ~ /  ===- ~~~</span>
<span class="go">       \______ o          __/</span>
<span class="go">        \    \        __/</span>
<span class="go">          \____\______/</span>
</pre></div>


<h2>Conclusion</h2>
<p>We created a Swarm cluster consisting of one manager and 10 agents, and we kept memory and disk usage low thanks to LXC containers. We also succeeded in confining our Docker containers with AppArmor. Overall, this setup is probably not ideal for use in a production environment, but very useful for simulating clusters on your laptop.</p>
<p>I hope you enjoyed the tutorial. Feel free to leave a comment if you have questions!</p></div>
      <footer class="container-fluid">
        <ul class="list-inline">
          <li class="social"><a href="https://twitter.com/share" class="twitter-share-button" data-url="http://andrea.corbellini.name/2016/04/13/docker-swarm-inside-lxc/" data-text="Running Docker Swarm inside LXC" data-via="andreacorbe">Tweet</a></li>
          <li class="social"><div class="fb-share-button" data-href="http://andrea.corbellini.name/2016/04/13/docker-swarm-inside-lxc/" data-layout="button_count"></div></li>
          <li class="social"><div class="g-plus" data-action="share" data-href="http://andrea.corbellini.name/2016/04/13/docker-swarm-inside-lxc/" data-annotation="bubble"></div></li>
          <li class="social"><script type="IN/Share" data-url="http://andrea.corbellini.name/2016/04/13/docker-swarm-inside-lxc/" data-counter="right"></script></li>
        </ul>
      </footer>
    </article>
      <section>
        <div class="comments">
          <div id="disqus_thread"></div>
          <noscript>Comments are powered by <a href="http://disqus.com/?ref_noscript">Disqus</a>. Enable JavaScript to see them.</noscript>
        </div>
      </section>
</main>
          <div class="sidebar right col-md-3">  <aside class="widget">
    <form action="http://andrea.corbellini.name/search/">
      <div class="input-group input-group-lg">
        <input type="text" name="q" class="form-control" placeholder="Search">
        <span class="input-group-btn">
          <button type="submit" id="tipue_search_button" class="btn btn-default"><span class="fa fa-search"></span></button>
        </span>
      </div>
    </form>
  </aside>
  <aside class="widget">
    <h1>Recent posts</h1>
    <ul class="articles">
        <li><a href="http://andrea.corbellini.name/2016/04/13/docker-swarm-inside-lxc/" title="Wed 13 April 2016">Running Docker Swarm inside LXC</a></li>
        <li><a href="http://andrea.corbellini.name/2015/09/22/cookie-law/" title="Tue 22 September 2015">When bureaucracy hits the web: the cookie law</a></li>
        <li><a href="http://andrea.corbellini.name/2015/08/02/hello-pelican/" title="Sun 02 August 2015">Hello Pelican!</a></li>
        <li><a href="http://andrea.corbellini.name/2015/06/16/lets-encrypt-is-going-to-start-soon/" title="Tue 16 June 2015">Let&#39;s Encrypt is going to start soon</a></li>
        <li><a href="http://andrea.corbellini.name/2015/06/08/elliptic-curve-cryptography-breaking-security-and-a-comparison-with-rsa/" title="Mon 08 June 2015">Elliptic Curve Cryptography: breaking security and a comparison with RSA</a></li>
        <li><a href="http://andrea.corbellini.name/2015/05/30/elliptic-curve-cryptography-ecdh-and-ecdsa/" title="Sat 30 May 2015">Elliptic Curve Cryptography: ECDH and ECDSA</a></li>
        <li><a href="http://andrea.corbellini.name/2015/05/23/elliptic-curve-cryptography-finite-fields-and-discrete-logarithms/" title="Sat 23 May 2015">Elliptic Curve Cryptography: finite fields and discrete logarithms</a></li>
        <li><a href="http://andrea.corbellini.name/2015/05/17/elliptic-curve-cryptography-a-gentle-introduction/" title="Sun 17 May 2015">Elliptic Curve Cryptography: a gentle introduction</a></li>
    </ul>
  </aside>
  <aside class="widget">
    <h1>Tags</h1>
    <ul class="tags list-inline">
        <li><a href="http://andrea.corbellini.name/tag/security/" class="btn btn-primary btn-sm" title="7 articles about security">security</a></li>
        <li><a href="http://andrea.corbellini.name/tag/tls/" class="btn btn-primary btn-sm" title="4 articles about tls">tls</a></li>
        <li><a href="http://andrea.corbellini.name/tag/ecc/" class="btn btn-primary btn-sm" title="4 articles about ecc">ecc</a></li>
        <li><a href="http://andrea.corbellini.name/tag/rsa/" class="btn btn-primary btn-sm" title="3 articles about rsa">rsa</a></li>
        <li><a href="http://andrea.corbellini.name/tag/math/" class="btn btn-primary btn-sm" title="3 articles about math">math</a></li>
        <li><a href="http://andrea.corbellini.name/tag/ecdsa/" class="btn btn-primary btn-sm" title="3 articles about ecdsa">ecdsa</a></li>
        <li><a href="http://andrea.corbellini.name/tag/dsa/" class="btn btn-primary btn-sm" title="3 articles about dsa">dsa</a></li>
        <li><a href="http://andrea.corbellini.name/tag/docker/" class="btn btn-primary btn-sm" title="3 articles about docker">docker</a></li>
        <li><a href="http://andrea.corbellini.name/tag/dh/" class="btn btn-primary btn-sm" title="3 articles about dh">dh</a></li>
        <li><a href="http://andrea.corbellini.name/tag/blog/" class="btn btn-primary btn-sm" title="3 articles about blog">blog</a></li>
        <li><a href="http://andrea.corbellini.name/tag/web/" class="btn btn-primary btn-sm" title="2 articles about web">web</a></li>
        <li><a href="http://andrea.corbellini.name/tag/lxc/" class="btn btn-primary btn-sm" title="2 articles about lxc">lxc</a></li>
        <li><a href="http://andrea.corbellini.name/tag/lets-encrypt/" class="btn btn-primary btn-sm" title="2 articles about let&#39;s encrypt">let&#39;s encrypt</a></li>
        <li><a href="http://andrea.corbellini.name/tag/ecdhe/" class="btn btn-primary btn-sm" title="2 articles about ecdhe">ecdhe</a></li>
        <li><a href="http://andrea.corbellini.name/tag/ecdh/" class="btn btn-primary btn-sm" title="2 articles about ecdh">ecdh</a></li>
        <li><a href="http://andrea.corbellini.name/tag/xkcd/" class="btn btn-primary btn-sm" title="1 articles about xkcd">xkcd</a></li>
        <li><a href="http://andrea.corbellini.name/tag/wordpress/" class="btn btn-primary btn-sm" title="1 articles about wordpress">wordpress</a></li>
        <li><a href="http://andrea.corbellini.name/tag/ubuntu-core/" class="btn btn-primary btn-sm" title="1 articles about ubuntu core">ubuntu core</a></li>
        <li><a href="http://andrea.corbellini.name/tag/ubuntu/" class="btn btn-primary btn-sm" title="1 articles about ubuntu">ubuntu</a></li>
        <li><a href="http://andrea.corbellini.name/tag/swarm/" class="btn btn-primary btn-sm" title="1 articles about swarm">swarm</a></li>
    </ul>
  </aside>
  <aside class="widget">
    <h1>License</h1>
    <p>The content of this blog is released under the terms of the <a href="http://creativecommons.org/licenses/by/4.0/" rel="license" title="CC-BY 4.0 International">Creative Commons Attribution 4.0 International License</a>.</p>
  </aside>
</div>
        </div>
      </div>
    <footer class="main-footer small">  <div class="container">
  <p>Copyright &copy; 2015 Andrea Corbellini</p>
  <p>Generated using <a href="http://getpelican.com/" title="Pelican">Pelican</a>. Hosted on <a href="https://pages.github.com/" title="GitHub pages">GitHub pages</a>. Uses <a href="http://getbootstrap.com/">Bootstrap</a>, <a href="https://jquery.com/" title="jQuery">jQuery</a>, <a href="http://fontawesome.io/" title="Font Awesome">Font Awesome</a> and <a href="https://www.mathjax.org/" title="MathJax">MathJax</a>.</p>
</div>
    <script>
      var disqus_shortname = "andreacorbellini";
      var disqus_identifier = "docker-swarm-inside-lxc";
      var disqus_title = "Running Docker Swarm inside LXC";
      var disqus_url = "http://andrea.corbellini.name/2016/04/13/docker-swarm-inside-lxc/";
      (function() {
          var s = document.createElement('script');
          s.async = true;
          s.defer = true;
          s.type = 'text/javascript';
          s.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(s);
      })();
    </script>
  <script>
    !function(d,s,id){
        var js, fjs = d.getElementsByTagName(s)[0], p = /^http:/.test(d.location) ? 'http' : 'https';
        if(!d.getElementById(id)) {
            js = d.createElement(s);
            js.id = id;
            js.async = true;
            js.defer = true;
            js.src = p + '://platform.twitter.com/widgets.js';
            fjs.parentNode.insertBefore(js,fjs);
        }
    }(document, 'script', 'twitter-wjs');
  </script>
  <script>
    (function(d, s, id) {
        var js, fjs = d.getElementsByTagName(s)[0];
        if (d.getElementById(id)) return;
        js = d.createElement(s);
        js.id = id;
        js.async = true;
        js.defer = true;
        js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&version=v2.4";
        fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));
  </script>
  <script src="https://apis.google.com/js/platform.js" async defer></script>
  <script src="//platform.linkedin.com/in.js" async defer>lang: en_US</script>
</footer>
<script>
  var cb = function() {
    var h = document.getElementsByTagName('head')[0];
    var l = document.createElement('link');
    l.rel = 'stylesheet';
    l.href = '//fonts.googleapis.com/css?family=Ubuntu+Mono:400,700|Open+Sans:400,700';
    h.parentNode.insertBefore(l, h);
    var l = document.createElement('link');
    l.rel = 'stylesheet';
    l.href = '//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.4.0/css/font-awesome.min.css';
    h.parentNode.insertBefore(l, h);
  };
  var raf = requestAnimationFrame || mozRequestAnimationFrame ||
      webkitRequestAnimationFrame || msRequestAnimationFrame;
  if (raf) raf(cb);
  else window.addEventListener('load', cb);
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]},
    elements: ['content']
  });
</script>
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.2.3/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.5/js/bootstrap.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.6.1/MathJax.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.6.1/config/TeX-AMS_HTML.js"></script>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', "UA-59812311-1", 'auto');
    ga('set', 'anonymizeIp', true);
    ga('send', 'pageview');
  </script>
  <script>
    var disqus_shortname = "andreacorbellini";
    (function() {
      var s = document.createElement('script');
      s.async = true;
      s.defer = true;
      s.type = 'text/javascript';
      s.src = '//' + disqus_shortname + '.disqus.com/count.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(s);
    })();
  </script>
  </body>
</html>